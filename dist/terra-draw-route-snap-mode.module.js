import{TerraDrawExtend as t}from"terra-draw";function i(){return i=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var r in e)({}).hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},i.apply(null,arguments)}function e(t,i){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},e(t,i)}var r=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],s=/*#__PURE__*/function(){function t(t,i,e,s){if(void 0===i&&(i=64),void 0===e&&(e=Float64Array),this.data=void 0,this.ids=void 0,this.coords=void 0,this._pos=void 0,this._finished=void 0,this.numItems=void 0,this.nodeSize=void 0,this.ArrayType=void 0,this.IndexArrayType=void 0,isNaN(t)||t<0)throw new Error("Unexpected numItems value: "+t+".");this.numItems=t,this.nodeSize=Math.min(Math.max(i,2),65535),this.ArrayType=e,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;var o=r.indexOf(this.ArrayType),n=2*t*this.ArrayType.BYTES_PER_ELEMENT,a=t*this.IndexArrayType.BYTES_PER_ELEMENT,h=(8-a%8)%8;if(o<0)throw new Error("Unexpected typed array class: "+e+".");s?(this.data=s,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+h,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+n+a+h),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+h,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+o]),new Uint16Array(this.data,2,1)[0]=this.nodeSize,new Uint32Array(this.data,4,1)[0]=this.numItems)}var i=t.prototype;return i.add=function(t,i){var e=this._pos>>1;return this.ids[e]=e,this.coords[this._pos++]=t,this.coords[this._pos++]=i,e},i.finish=function(){var t=this._pos>>1;if(t!==this.numItems)throw new Error("Added "+t+" items when expected "+this.numItems+".");return o(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this},t}();function o(t,i,e,r,s,a){if(!(s-r<=e)){var h=r+s>>1;n(t,i,h,r,s,a),o(t,i,e,r,h-1,1-a),o(t,i,e,h+1,s,1-a)}}function n(t,i,e,r,s,o){for(;s>r;){if(s-r>600){var h=s-r+1,d=e-r+1,u=Math.log(h),c=.5*Math.exp(2*u/3),p=.5*Math.sqrt(u*c*(h-c)/h)*(d-h/2<0?-1:1);n(t,i,e,Math.max(r,Math.floor(e-d*c/h+p)),Math.min(s,Math.floor(e+(h-d)*c/h+p)),o)}var l=i[2*e+o],f=r,v=s;for(a(t,i,r,e),i[2*s+o]>l&&a(t,i,r,s);f<v;){for(a(t,i,f,v),f++,v--;i[2*f+o]<l;)f++;for(;i[2*v+o]>l;)v--}i[2*r+o]===l?a(t,i,r,v):a(t,i,++v,s),v<=e&&(r=v+1),e<=v&&(s=v-1)}}function a(t,i,e,r){h(t,e,r),h(i,2*e,2*r),h(i,2*e+1,2*r+1)}function h(t,i,e){var r=t[i];t[i]=t[e],t[e]=r}var d=/*#__PURE__*/function(){function t(t,i){if(void 0===t&&(t=[]),void 0===i&&(i=function(t,i){return t<i?-1:t>i?1:0}),this.data=void 0,this.length=void 0,this.compare=void 0,this.data=t,this.length=this.data.length,this.compare=i,this.length>0)for(var e=(this.length>>1)-1;e>=0;e--)this._down(e)}var i=t.prototype;return i.push=function(t){this.data.push(t),this._up(this.length++)},i.pop=function(){if(0!==this.length){var t=this.data[0],i=this.data.pop();return this.length--,this.length>0&&(this.data[0]=i,this._down(0)),t}},i.peek=function(){return this.data[0]},i._up=function(t){for(var i=this.data,e=this.compare,r=i[t];t>0;){var s=t-1>>1,o=i[s];if(e(r,o)>=0)break;i[t]=o,t=s}i[t]=r},i._down=function(t){for(var i=this.data,e=this.compare,r=this.length>>1,s=i[t];t<r;){var o=1+(t<<1),n=o+1;if(n<this.length&&e(i[n],i[o])<0&&(o=n),e(i[o],s)>=0)break;i[t]=i[o],t=o}i[t]=s},t}(),u=Math.PI/180;function c(t,i,e,r){var s=r.minLng,o=r.maxLng,n=r.minLat,a=r.maxLat;if(t>=s&&t<=o)return i<n?l((i-n)*u):i>a?l((i-a)*u):0;var h=Math.min(l((t-s)*u),l((t-o)*u)),d=function(t,i){var e=1-2*i;return e<=0?t>0?90:-90:Math.atan(Math.tan(t*u)/e)/u}(i,h);return d>n&&d<a?f(h,e,i,d):Math.min(f(h,e,i,n),f(h,e,i,a))}function p(t,i){return t.dist-i.dist}function l(t){var i=Math.sin(t/2);return i*i}function f(t,i,e,r){return i*Math.cos(r*u)*t+l((e-r)*u)}function v(t,i,e,r,s){return f(l((t-e)*u),s,i,r)}var y=/*#__PURE__*/function(){function t(t){this.useCache=!0,this.indexedNetworkPoints=void 0,this.points=[],this.routeFinder=void 0,this.network=void 0,this.routeCache={},this.useCache=t.useCache||!0,this.network=t.network,this.routeFinder=t.routeFinder,this.initialise()}var i=t.prototype;return i.initialise=function(){var t=this;this.network.features.forEach(function(i){i.geometry.coordinates.forEach(function(i){t.points.push(i)})}),this.indexedNetworkPoints=new s(this.points.length),this.points.forEach(function(i){t.indexedNetworkPoints.add(i[0],i[1])}),this.indexedNetworkPoints.finish(),this.routeCache={}},i.getClosestNetworkCoordinate=function(t){var i=function(t,i,e,r,s){void 0===r&&(r=Infinity),void 0===s&&(s=Infinity);var o=1,n=[];void 0===r&&(r=Infinity),void 0!==s&&(o=l(s/6371));for(var a=new d([],p),h={left:0,right:t.ids.length-1,axis:0,dist:0,minLng:-180,minLat:-90,maxLng:180,maxLat:90},f=Math.cos(e*u);h;){var y=h.right,m=h.left;if(y-m<=t.nodeSize)for(var g=m;g<=y;g++){var I=t.ids[g],x=v(i,e,t.coords[2*g],t.coords[2*g+1],f);a.push({id:I,dist:x})}else{var w=m+y>>1,C=t.coords[2*w],L=t.coords[2*w+1],P=t.ids[w],E=v(i,e,C,L,f);a.push({id:P,dist:E});var A=(h.axis+1)%2,k={left:m,right:w-1,axis:A,minLng:h.minLng,minLat:h.minLat,maxLng:0===h.axis?C:h.maxLng,maxLat:1===h.axis?L:h.maxLat,dist:0},M={left:w+1,right:y,axis:A,minLng:0===h.axis?C:h.minLng,minLat:1===h.axis?L:h.minLat,maxLng:h.maxLng,maxLat:h.maxLat,dist:0};k.dist=c(i,e,f,k),M.dist=c(i,e,f,M),a.push(k),a.push(M)}for(;a.length&&null!=a.peek().id;){var S=a.pop();if(S.dist>o)return n;if(n.push(S.id),n.length===r)return n}h=a.pop()}return n}(this.indexedNetworkPoints,t[0],t[1],1);return this.points[i[0]]||null},i.setRouteFinder=function(t){this.routeFinder=t},i.setNetwork=function(t){this.network=t,this.routeFinder.setNetwork(t),this.initialise()},i.getRoute=function(t,i){if(this.useCache){var e=t+"-"+i;if(this.routeCache[e])return this.routeCache[e]}var r=this.routeFinder.getRoute({type:"Feature",geometry:{type:"Point",coordinates:t},properties:{}},{type:"Feature",geometry:{type:"Point",coordinates:i},properties:{}});return this.useCache?(this.routeCache[t+"-"+i]=r,r):r},t}(),m={cancel:"Escape",finish:"Enter"},g={draw:"crosshair",close:"pointer"},I=/*#__PURE__*/function(r){function s(t){var i;return(i=r.call(this,t,!0)||this).mode="routesnap",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=m,i.cursors=g,i.maxPoints=1,i.moveLineId=void 0,i.routing=void 0,i.currentPointIds=[],i.routeId=0,i.pixelDistance=function(t,i){var e=i.x-t.x,r=i.y-t.y;return Math.sqrt(r*r+e*e)},i.latestEvent=null,i.updateOptions(t),i}var o,n;n=r,(o=s).prototype=Object.create(n.prototype),o.prototype.constructor=o,e(o,n);var a=s.prototype;return a.updateOptions=function(t){r.prototype.updateOptions.call(this,t),null!=t&&t.routing&&t.routing!==this.routing&&(this.cleanUp(),this.routing=t.routing),void 0!==(null==t?void 0:t.maxPoints)&&t.maxPoints!==this.maxPoints&&t.maxPoints>0&&(this.maxPoints=t.maxPoints),null!=t&&t.cursors&&(this.cursors=i({},this.cursors,t.cursors)),null===(null==t?void 0:t.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=t&&t.keyEvents&&(this.keyEvents=i({},this.keyEvents,t.keyEvents))},a.measure=function(t,i){var e=this.project(i[0],i[1]);return this.pixelDistance({x:e.x,y:e.y},{x:t.containerX,y:t.containerY})},a.close=function(){this.currentId&&(this.currentCoordinate=0,this.currentId=void 0,this.currentPointIds=[],"drawing"===this.state&&this.setStarted())},a.registerBehaviors=function(t){},a.start=function(){this.setStarted(),this.setCursor(this.cursors.draw)},a.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},a.onMouseMove=function(t){var i=this;this.latestEvent=t,requestAnimationFrame(function(){var t=i.latestEvent;t&&(i.processMouseMove(t),i.latestEvent=null)})},a.processMouseMove=function(t){if(this.setCursor(this.cursors.draw),this.moveLineId&&!this.store.has(this.moveLineId)&&(this.moveLineId=void 0),this.currentId&&0!==this.currentCoordinate){var i=this.store.getGeometryCopy(this.currentId);if(i){if(this.measure(t,i.coordinates[i.coordinates.length-1])<this.pointerDistance){if(this.setCursor(this.cursors.close),!this.moveLineId)return;return this.store.has(this.moveLineId)&&this.store.delete([this.moveLineId]),void(this.moveLineId=void 0)}var e=this.store.getGeometryCopy(this.currentId);if(e){var r=this.routing.getClosestNetworkCoordinate([t.lng,t.lat]);if(r){var s=this.routing.getRoute(e.coordinates[e.coordinates.length-1],r);if(s)if(this.moveLineId)this.store.updateGeometry([{id:this.moveLineId,geometry:s.geometry}]);else{var o=this.store.create([{geometry:s.geometry,properties:{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}}]);this.moveLineId=o[0]}}}}}},a.onClick=function(t){if("right"!==t.button){var e=[t.lng,t.lat];if(this.currentId&&!this.store.has(this.currentId)&&(this.currentId=void 0,this.currentCoordinate=0,this.currentPointIds=[]),this.currentId){var r=this.store.getGeometryCopy(this.currentId);if(this.measure(t,r.coordinates[r.coordinates.length-1])<this.pointerDistance)return 1===this.currentCoordinate&&this.store.delete(this.currentPointIds),void this.close()}else this.routeId++;var s=this.routing.getClosestNetworkCoordinate(e);if(0===this.currentCoordinate){if(s){var o=this.store.create([{geometry:{type:"LineString",coordinates:[s]},properties:{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}},{geometry:{type:"Point",coordinates:s},properties:{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}}]),n=o[1];this.currentId=o[0],this.currentPointIds.push(n),this.currentCoordinate++,"started"===this.state&&this.setDrawing()}}else if(1===this.currentCoordinate&&this.currentId&&s){var a=this.store.getGeometryCopy(this.currentId),h=this.routing.getRoute(a.coordinates[0],s);if(h){this.store.updateGeometry([{id:this.currentId,geometry:null==h?void 0:h.geometry}]);var d=this.store.create([{geometry:{type:"Point",coordinates:s},properties:{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}}])[0];this.currentCoordinate=2,this.currentPointIds.push(d)}if(1===this.maxPoints)return void this.close()}else if(this.currentCoordinate>1&&this.currentId&&s&&this.currentCoordinate<=this.maxPoints){var u=this.store.getGeometryCopy(this.currentId),c=this.routing.getRoute(u.coordinates[u.coordinates.length-1],s);if(c){var p=i({},u,{coordinates:[].concat(u.coordinates,c.geometry.coordinates)});this.store.updateGeometry([{id:this.currentId,geometry:p}]);var l=this.store.create([{geometry:{type:"Point",coordinates:s},properties:{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}}])[0];this.maxPoints===this.currentCoordinate?this.close():(this.currentCoordinate++,this.currentPointIds.push(l))}}}},a.onKeyDown=function(){},a.onKeyUp=function(t){t.key===this.keyEvents.cancel&&this.cleanUp(),t.key===this.keyEvents.finish&&this.close()},a.onDragStart=function(){},a.onDrag=function(){},a.onDragEnd=function(){},a.cleanUp=function(){try{this.currentId&&this.store.delete([this.currentId].concat(this.currentPointIds))}catch(t){}this.currentId=void 0,this.moveLineId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted()},a.styleFeature=function(i){var e=t.getDefaultStyling();return"Feature"===i.type&&"LineString"===i.geometry.type&&i.properties.mode===this.mode?(e.lineStringColor=this.getHexColorStylingValue(this.styles.lineStringColor,"#B90E0A",i),e.lineStringWidth=this.getNumericStylingValue(this.styles.lineStringWidth,4,i),e.zIndex=10,e):"Feature"===i.type&&"Point"===i.geometry.type&&i.properties.mode===this.mode?(e.pointColor=this.getHexColorStylingValue(this.styles.routePointColor,"#B90E0A",i),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.routePointColor,"#B90E0A",i),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.routePointOutlineWidth,1,i),e):e},a.validateFeature=function(t){return r.prototype.validateFeature.call(this,t)},a.afterFeatureAdded=function(t){},s}(t.TerraDrawBaseDrawMode);export{y as Routing,I as TerraDrawRouteSnapMode};
//# sourceMappingURL=terra-draw-route-snap-mode.module.js.map
