!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("terra-draw")):"function"==typeof define&&define.amd?define(["exports","terra-draw"],e):e((t||self).terraDrawRouteSnapMode={},t.terraDraw)}(this,function(t,e){function i(){return i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)({}).hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},i.apply(null,arguments)}function r(t,e){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},r(t,e)}var n=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],o=/*#__PURE__*/function(){function t(t,e,i,r){if(void 0===e&&(e=64),void 0===i&&(i=Float64Array),this.data=void 0,this.ids=void 0,this.coords=void 0,this._pos=void 0,this._finished=void 0,this.numItems=void 0,this.nodeSize=void 0,this.ArrayType=void 0,this.IndexArrayType=void 0,isNaN(t)||t<0)throw new Error("Unexpected numItems value: "+t+".");this.numItems=t,this.nodeSize=Math.min(Math.max(e,2),65535),this.ArrayType=i,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;var o=n.indexOf(this.ArrayType),s=2*t*this.ArrayType.BYTES_PER_ELEMENT,a=t*this.IndexArrayType.BYTES_PER_ELEMENT,h=(8-a%8)%8;if(o<0)throw new Error("Unexpected typed array class: "+i+".");r?(this.data=r,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+h,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+s+a+h),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+h,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+o]),new Uint16Array(this.data,2,1)[0]=this.nodeSize,new Uint32Array(this.data,4,1)[0]=this.numItems)}var e=t.prototype;return e.add=function(t,e){var i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=t,this.coords[this._pos++]=e,i},e.finish=function(){var t=this._pos>>1;if(t!==this.numItems)throw new Error("Added "+t+" items when expected "+this.numItems+".");return s(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this},t}();function s(t,e,i,r,n,o){if(!(n-r<=i)){var h=r+n>>1;a(t,e,h,r,n,o),s(t,e,i,r,h-1,1-o),s(t,e,i,h+1,n,1-o)}}function a(t,e,i,r,n,o){for(;n>r;){if(n-r>600){var s=n-r+1,u=i-r+1,d=Math.log(s),c=.5*Math.exp(2*d/3),l=.5*Math.sqrt(d*c*(s-c)/s)*(u-s/2<0?-1:1);a(t,e,i,Math.max(r,Math.floor(i-u*c/s+l)),Math.min(n,Math.floor(i+(s-u)*c/s+l)),o)}var g=e[2*i+o],f=r,p=n;for(h(t,e,r,i),e[2*n+o]>g&&h(t,e,r,n);f<p;){for(h(t,e,f,p),f++,p--;e[2*f+o]<g;)f++;for(;e[2*p+o]>g;)p--}e[2*r+o]===g?h(t,e,r,p):h(t,e,++p,n),p<=i&&(r=p+1),i<=p&&(n=p-1)}}function h(t,e,i,r){u(t,i,r),u(e,2*i,2*r),u(e,2*i+1,2*r+1)}function u(t,e,i){var r=t[e];t[e]=t[i],t[i]=r}var d=/*#__PURE__*/function(){function t(t,e){if(void 0===t&&(t=[]),void 0===e&&(e=function(t,e){return t<e?-1:t>e?1:0}),this.data=void 0,this.length=void 0,this.compare=void 0,this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(var i=(this.length>>1)-1;i>=0;i--)this._down(i)}var e=t.prototype;return e.push=function(t){this.data.push(t),this._up(this.length++)},e.pop=function(){if(0!==this.length){var t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}},e.peek=function(){return this.data[0]},e._up=function(t){for(var e=this.data,i=this.compare,r=e[t];t>0;){var n=t-1>>1,o=e[n];if(i(r,o)>=0)break;e[t]=o,t=n}e[t]=r},e._down=function(t){for(var e=this.data,i=this.compare,r=this.length>>1,n=e[t];t<r;){var o=1+(t<<1),s=o+1;if(s<this.length&&i(e[s],e[o])<0&&(o=s),i(e[o],n)>=0)break;e[t]=e[o],t=o}e[t]=n},t}(),c=Math.PI/180;function l(t,e,i,r,n){void 0===r&&(r=Infinity),void 0===n&&(n=Infinity);var o=1,s=[];void 0===r&&(r=Infinity),void 0!==n&&(o=p(n/6371));for(var a=new d([],f),h={left:0,right:t.ids.length-1,axis:0,dist:0,minLng:-180,minLat:-90,maxLng:180,maxLat:90},u=Math.cos(i*c);h;){var l=h.right,v=h.left;if(l-v<=t.nodeSize)for(var y=v;y<=l;y++){var C=t.ids[y],L=m(e,i,t.coords[2*y],t.coords[2*y+1],u);a.push({id:C,dist:L})}else{var w=v+l>>1,I=t.coords[2*w],k=t.coords[2*w+1],x=t.ids[w],S=m(e,i,I,k,u);a.push({id:x,dist:S});var R=(h.axis+1)%2,P={left:v,right:w-1,axis:R,minLng:h.minLng,minLat:h.minLat,maxLng:0===h.axis?I:h.maxLng,maxLat:1===h.axis?k:h.maxLat,dist:0},F={left:w+1,right:l,axis:R,minLng:0===h.axis?I:h.minLng,minLat:1===h.axis?k:h.minLat,maxLng:h.maxLng,maxLat:h.maxLat,dist:0};P.dist=g(e,i,u,P),F.dist=g(e,i,u,F),a.push(P),a.push(F)}for(;a.length&&null!=a.peek().id;){var M=a.pop();if(M.dist>o)return s;if(s.push(M.id),s.length===r)return s}h=a.pop()}return s}function g(t,e,i,r){var n=r.minLng,o=r.maxLng,s=r.minLat,a=r.maxLat;if(t>=n&&t<=o)return e<s?p((e-s)*c):e>a?p((e-a)*c):0;var h=Math.min(p((t-n)*c),p((t-o)*c)),u=function(t,e){var i=1-2*e;return i<=0?t>0?90:-90:Math.atan(Math.tan(t*c)/i)/c}(e,h);return u>s&&u<a?v(h,i,e,u):Math.min(v(h,i,e,s),v(h,i,e,a))}function f(t,e){return t.dist-e.dist}function p(t){var e=Math.sin(t/2);return e*e}function v(t,e,i,r){return e*Math.cos(r*c)*t+p((i-r)*c)}function m(t,e,i,r,n){return v(p((t-i)*c),n,e,r)}var y=/*#__PURE__*/function(){function t(t){this.useCache=!0,this.indexedNetworkPoints=void 0,this.points=[],this.routeFinder=void 0,this.network=void 0,this.routeCache={},this.useCache=void 0===t.useCache||t.useCache,this.network=this.clone(t.network),this.routeFinder=t.routeFinder,this.initialise()}var e=t.prototype;return e.initialise=function(){var t=this;this.network.features.forEach(function(e){e.geometry.coordinates.forEach(function(e){t.points.push(e)})}),this.indexedNetworkPoints=new o(this.points.length),this.points.forEach(function(e){t.indexedNetworkPoints.add(e[0],e[1])}),this.indexedNetworkPoints.finish(),this.routeCache={}},e.getNodeCount=function(){return this.indexedNetworkPoints.ids.length},e.getClosestNetworkCoordinate=function(t){var e=l(this.indexedNetworkPoints,t[0],t[1],1);return this.points[e[0]]||null},e.getClosestNetworkCoordinates=function(t,e,i){var r=this,n=l(this.indexedNetworkPoints,t[0],t[1],e,i),o=[];return n.forEach(function(t){o.push(r.points[t])}),o},e.setRouteFinder=function(t){this.routeFinder=t},e.setNetwork=function(t){this.network=this.clone(t),this.routeFinder.setNetwork(t),this.initialise()},e.expandRouteNetwork=function(t){var e=this.clone(t);this.routeFinder.expandNetwork(e);var i={type:"FeatureCollection",features:[].concat(e.features,this.network.features)};this.network=i,this.initialise()},e.getRoute=function(t,e){if(this.useCache){var i=t+"-"+e;if(i in this.routeCache)return this.routeCache[i]}var r=this.routeFinder.getRoute({type:"Feature",geometry:{type:"Point",coordinates:t},properties:{}},{type:"Feature",geometry:{type:"Point",coordinates:e},properties:{}});return this.useCache?(this.routeCache[t+"-"+e]=r,r):r},e.clone=function(t){return JSON.parse(JSON.stringify(t))},t}(),C={cancel:"Escape",finish:"Enter"},L={draw:"crosshair",close:"pointer"},w=/*#__PURE__*/function(t){function n(e){var i;return(i=t.call(this,e,!0)||this).mode="routesnap",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=C,i.cursors=L,i.maxPoints=2,i.moveLineId=void 0,i.routing=void 0,i.currentPointIds=[],i.routeId=0,i.latestMouseMoveEvent=null,i.straightLineFallback=!1,i.isDrawingStraightLine=!1,i.didIncrementRouteIdForCurrentRoute=!1,i.pixelDistance=function(t,e){var i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)},i.updateOptions(e),i}var o,s;s=t,(o=n).prototype=Object.create(s.prototype),o.prototype.constructor=o,r(o,s);var a=n.prototype;return a.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.routing&&e.routing!==this.routing&&(this.cleanUp(),this.routing=e.routing),void 0!==(null==e?void 0:e.maxPoints)&&e.maxPoints!==this.maxPoints&&e.maxPoints>=2&&(this.maxPoints=e.maxPoints),null!=e&&e.cursors&&(this.cursors=i({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=i({},this.keyEvents,e.keyEvents)),void 0!==(null==e?void 0:e.straightLineFallback)&&(this.straightLineFallback=e.straightLineFallback)},a.measure=function(t,e){var i=this.project(e[0],e[1]);return this.pixelDistance({x:i.x,y:i.y},{x:t.containerX,y:t.containerY})},a.measureCoordinateToCoordinate=function(t,e){var i=this.project(t[0],t[1]);return this.measure({lng:t[0],lat:t[1],containerX:i.x,containerY:i.y,button:"left",heldKeys:[]},e)},a.close=function(){this.currentId&&(this.currentCoordinate=0,this.currentId=void 0,this.currentPointIds=[],this.isDrawingStraightLine=!1,"drawing"===this.state&&this.setStarted())},a.finish=function(){var t=this;if(this.currentId){this.didIncrementRouteIdForCurrentRoute=!1;var e=[this.moveLineId].concat(this.currentPointIds).filter(function(e){return Boolean(e)&&t.store.has(e)});e.length&&this.store.delete(e),this.onFinish(this.currentId,{mode:this.mode,action:"draw"}),this.close()}},a.getFeatureProperties=function(){return{mode:this.mode,isDrawnRoute:!0,routeId:this.routeId}},a.getStraightLineString=function(t){return{type:"Feature",geometry:{type:"LineString",coordinates:t},properties:this.getFeatureProperties()}},a.createRoutePoint=function(t){return this.store.create([{geometry:{type:"Point",coordinates:t},properties:this.getFeatureProperties()}])[0]},a.updateRoute=function(t){var e=this.routing.getRoute(t.currentLastCoordinate,t.closestNetworkCoordinate);e&&(this.moveLineId?this.updateMoveLine(e.geometry.coordinates):this.createMoveLine(e.geometry.coordinates))},a.getMaxResults=function(){var t=Math.ceil(this.routing.getNodeCount()/100);return{maxResults:Math.min(Math.max(t,10),1e3),maxDistance:Infinity}},a.isClosestNetworkCoordinateNearPrevious=function(t,e){var i=this,r=this.getMaxResults();return this.routing.getClosestNetworkCoordinates(t,r.maxResults,r.maxDistance).filter(function(e){return i.measureCoordinateToCoordinate(t,e)<=i.pointerDistance}).some(function(t){return t[0]===e[0]&&t[1]===e[1]})},a.resolveFallbackRouteLine=function(t){var e=t.routedLine,i=t.straightLine;return t.forceStraightLine||this.isClosestNetworkCoordinateNearPrevious(i.geometry.coordinates[0],t.closestNetworkCoordinate)?{linestringRoute:i,isStraightLine:!0}:{linestringRoute:e||void 0,isStraightLine:!1}},a.updateRouteWithFallback=function(t){var e=t.event,i=t.currentLastCoordinate,r=t.closestNetworkCoordinate,n=this.getStraightLineString([i,[e.lng,e.lat]]),o=this.routing.getRoute(i,r),s=this.resolveFallbackRouteLine({closestNetworkCoordinate:r,routedLine:o,straightLine:n,forceStraightLine:this.isDrawingStraightLine}).linestringRoute;s&&(this.moveLineId?this.updateMoveLine(s.geometry.coordinates):this.createMoveLine(s.geometry.coordinates))},a.clickGetUpdateRoute=function(t){var e=t.closestNetworkCoordinate;return{linestringRoute:this.routing.getRoute(t.fromCoordinate,e),pointToCreate:e}},a.clickGetUpdateRouteWithFallback=function(t){var e=t.event,i=t.fromCoordinate,r=t.closestNetworkCoordinate,n=[e.lng,e.lat],o=this.getStraightLineString([i,n]),s=this.routing.getRoute(i,r),a=this.resolveFallbackRouteLine({closestNetworkCoordinate:r,routedLine:s,straightLine:o,forceStraightLine:this.isDrawingStraightLine}),h=a.isStraightLine;return{linestringRoute:a.linestringRoute,pointToCreate:h?n:r,isStraightLine:h}},a.createMoveLine=function(t){var e=this.store.create([{geometry:{type:"LineString",coordinates:t},properties:this.getFeatureProperties()}]);this.moveLineId=e[0]},a.updateMoveLine=function(t){this.moveLineId&&this.store.updateGeometry([{id:this.moveLineId,geometry:{type:"LineString",coordinates:t}}])},a.processCursorMove=function(t){if(this.setCursor(this.cursors.draw),this.moveLineId&&!this.store.has(this.moveLineId)&&(this.moveLineId=void 0),this.currentId&&0!==this.currentCoordinate){if(!this.store.has(this.currentId))return this.currentId=void 0,this.currentCoordinate=0,void(this.currentPointIds=[]);var e=this.store.getGeometryCopy(this.currentId);if(e){var i=e.coordinates,r=i[i.length-1];if(this.measure(t,r)<this.pointerDistance){if(this.setCursor(this.cursors.close),!this.moveLineId)return;return this.store.has(this.moveLineId)&&this.store.delete([this.moveLineId]),void(this.moveLineId=void 0)}var n=this.routing.getClosestNetworkCoordinate([t.lng,t.lat]);n&&(this.straightLineFallback?this.updateRouteWithFallback({event:t,currentLastCoordinate:r,closestNetworkCoordinate:n}):this.updateRoute({currentLastCoordinate:r,closestNetworkCoordinate:n}))}}},a.registerBehaviors=function(t){},a.start=function(){this.setStarted(),this.setCursor(this.cursors.draw)},a.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},a.onMouseMove=function(t){var e=this;this.latestMouseMoveEvent=t,requestAnimationFrame(function(){var t=e.latestMouseMoveEvent;t&&(e.processCursorMove(t),e.latestMouseMoveEvent=null)})},a.onClick=function(t){if("right"!==t.button){var e=[t.lng,t.lat];if(this.currentId&&!this.store.has(this.currentId)&&(this.currentId=void 0,this.currentCoordinate=0,this.currentPointIds=[],this.isDrawingStraightLine=!1),this.currentId){var r=this.store.getGeometryCopy(this.currentId).coordinates;if(this.measure(t,r[r.length-1])<this.pointerDistance)return void this.finish()}else this.routeId++,this.didIncrementRouteIdForCurrentRoute=!0,this.isDrawingStraightLine=!1;var n=this.routing.getClosestNetworkCoordinate(e);if(0===this.currentCoordinate&&n){var o=this.store.create([{geometry:{type:"LineString",coordinates:[n]},properties:this.getFeatureProperties()},{geometry:{type:"Point",coordinates:n},properties:this.getFeatureProperties()}]),s=o[1];this.currentId=o[0],this.currentPointIds.push(s),this.currentCoordinate++,"started"===this.state&&this.setDrawing()}else if(1===this.currentCoordinate&&this.currentId&&n){var a=this.store.getGeometryCopy(this.currentId).coordinates[0],h=this.straightLineFallback?this.clickGetUpdateRouteWithFallback({event:t,fromCoordinate:a,closestNetworkCoordinate:n}):this.clickGetUpdateRoute({fromCoordinate:a,closestNetworkCoordinate:n});if(h&&h.linestringRoute){this.store.updateGeometry([{id:this.currentId,geometry:h.linestringRoute.geometry}]),this.isDrawingStraightLine=!!(this.straightLineFallback&&h&&"isStraightLine"in h)&&h.isStraightLine;var u=this.createRoutePoint(h.pointToCreate);this.currentCoordinate=2,this.currentPointIds.push(u),this.currentCoordinate>=this.maxPoints&&this.finish()}}else if(this.currentCoordinate>1&&this.currentId&&n&&this.currentCoordinate<this.maxPoints){var d=this.store.getGeometryCopy(this.currentId),c=d.coordinates[d.coordinates.length-1],l=this.straightLineFallback?this.clickGetUpdateRouteWithFallback({event:t,fromCoordinate:c,closestNetworkCoordinate:n}):this.clickGetUpdateRoute({fromCoordinate:c,closestNetworkCoordinate:n});if(l&&l.linestringRoute){var g=i({},d,{coordinates:[].concat(d.coordinates,l.linestringRoute.geometry.coordinates.slice(1))});if(this.store.updateGeometry([{id:this.currentId,geometry:g}]),this.isDrawingStraightLine=!!(this.straightLineFallback&&l&&"isStraightLine"in l)&&l.isStraightLine,this.currentCoordinate+1>this.maxPoints)this.finish();else{var f=this.createRoutePoint(l.pointToCreate);this.currentCoordinate++,this.currentPointIds.push(f),this.currentCoordinate===this.maxPoints&&this.finish()}}}}},a.onKeyDown=function(){},a.onKeyUp=function(t){t.key===this.keyEvents.cancel&&this.cleanUp(),t.key===this.keyEvents.finish&&this.finish()},a.onDragStart=function(){},a.onDrag=function(){},a.onDragEnd=function(){},a.cleanUp=function(){var t=this;if(this.store){var e=[this.currentId,this.moveLineId].concat(this.currentPointIds).filter(function(e){return e&&t.store.has(e)});this.store.delete(e),this.currentId=void 0,this.moveLineId=void 0,this.currentPointIds=[],this.currentCoordinate=0,this.isDrawingStraightLine=!1,this.didIncrementRouteIdForCurrentRoute&&(this.routeId=Math.max(0,this.routeId-1),this.didIncrementRouteIdForCurrentRoute=!1),"drawing"===this.state&&this.setStarted()}},a.styleFeature=function(t){var i=e.TerraDrawExtend.getDefaultStyling();return"Feature"===t.type&&"LineString"===t.geometry.type&&t.properties.mode===this.mode?(i.lineStringColor=this.getHexColorStylingValue(this.styles.lineStringColor,"#B90E0A",t),i.lineStringWidth=this.getNumericStylingValue(this.styles.lineStringWidth,4,t),i.zIndex=10,i):"Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode?(i.pointColor=this.getHexColorStylingValue(this.styles.routePointColor,"#B90E0A",t),i.pointOutlineColor=this.getHexColorStylingValue(this.styles.routePointOutlineColor,"#B90E0A",t),i.pointOutlineWidth=this.getNumericStylingValue(this.styles.routePointOutlineWidth,1,t),i):i},a.validateFeature=function(e){return t.prototype.validateFeature.call(this,e)},a.afterFeatureAdded=function(t){},n}(e.TerraDrawExtend.TerraDrawBaseDrawMode);t.Routing=y,t.TerraDrawRouteSnapMode=w});
//# sourceMappingURL=terra-draw-route-snap-mode.umd.js.map
